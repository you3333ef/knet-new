<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gulf Bank PayLink - KNET Payment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        h2 {
            text-align: center;
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: normal;
        }
        .status-message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .payment-details {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .payment-details h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: bold;
            color: #555;
        }
        .detail-value {
            color: #333;
            text-align: right;
        }
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            min-width: 120px;
        }
        button:hover {
            opacity: 0.9;
        }
        .accept-btn {
            background-color: #28a745;
            color: white;
        }
        .decline-btn {
            background-color: #dc3545;
            color: white;
        }
        .home-btn {
            background-color: #007bff;
            color: white;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .bilingual {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }
        .english {
            font-size: 16px;
        }
        .arabic {
            font-size: 14px;
            direction: rtl;
            text-align: center;
        }
        .ref-box {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gulf Bank PayLink</h1>
        <h2>KNET Payment Gateway</h2>

        <div class="status-message info" id="loadingScreen">
            <div class="bilingual">
                <div class="english">One moment please...</div>
                <div class="arabic">لحظة من فضلك...</div>
            </div>
        </div>

        <div id="paymentContent" style="display: none;">
            <div class="payment-details">
                <h3>Payment Details / تفاصيل الدفع</h3>

                <div class="detail-row">
                    <span class="detail-label">Payment Beneficiary:</span>
                    <span class="detail-value" id="beneficiary">-</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Amount / المبلغ:</span>
                    <span class="detail-value" id="amount">-</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Currency / العملة:</span>
                    <span class="detail-value" id="currency">KWD</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Payment Date / تاريخ الدفع:</span>
                    <span class="detail-value" id="paymentDate">-</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Reference No / المرجع:</span>
                    <span class="detail-value ref-box" id="referenceNumber">-</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Transaction ID / معرف العملية:</span>
                    <span class="detail-value" id="transactionId">-</span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Description / الوصف:</span>
                    <span class="detail-value" id="description">-</span>
                </div>
            </div>

            <div class="status-message" id="statusMessage" style="display: none;">
                <div class="bilingual">
                    <div id="statusText">-</div>
                    <div class="arabic" id="statusTextAr">-</div>
                </div>
            </div>

            <div class="buttons" id="actionButtons">
                <button class="accept-btn" id="acceptBtn" onclick="handlePayment('completed')">
                    <div class="bilingual">
                        <div class="english">Accept</div>
                        <div class="arabic">قبول</div>
                    </div>
                </button>
                <button class="decline-btn" id="declineBtn" onclick="handlePayment('cancelled')">
                    <div class="bilingual">
                        <div class="english">Decline</div>
                        <div class="arabic">رفض</div>
                    </div>
                </button>
            </div>

            <div class="buttons">
                <button class="home-btn" onclick="goHome()">
                    <div class="bilingual">
                        <div class="english">Go to Homepage</div>
                        <div class="arabic">الذهاب إلى الصفحة الرئيسية</div>
                    </div>
                </button>
            </div>
        </div>

        <div class="status-message warning" id="expiredScreen" style="display: none;">
            <div class="bilingual">
                <div class="english">⚠️ The link is either expired or the payment has been done.</div>
                <div class="arabic">⚠️ انتهت صلاحية الرابط أو سبق أن تم سداد الدفعة</div>
            </div>
        </div>

        <div class="footer">
            <div>Secured by KNET Payment Gateway</div>
            <div>© 2024 Gulf Bank PayLink - Protected & Secured</div>
        </div>
    </div>

    <script>
        let referenceNumber = '';
        let isDemoMode = false;

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        referenceNumber = urlParams.get('refNo');
        const language = urlParams.get('islang') || 'en';

        // Check if running in demo mode (when no backend)
        if (window.location.hostname.includes('netlify.app') || !referenceNumber) {
            isDemoMode = true;
        }

        // Demo data
        const demoPaymentData = {
            beneficiary: 'ABC Company LLC',
            amount: '100.000',
            currency: 'KWD',
            description: 'Invoice #INV-001 - Payment',
            referenceNumber: referenceNumber || 'Iza5yRt0DCwymNB',
            transactionId: 'TXN-' + Math.random().toString(36).substring(2, 10).toUpperCase(),
            paymentDate: new Date().toLocaleDateString('en-GB')
        };

        async function loadPaymentDetails() {
            try {
                let data;

                if (isDemoMode || !referenceNumber) {
                    // Use demo data
                    data = { data: demoPaymentData, demo: true };
                } else {
                    // Try to fetch from API
                    const response = await fetch(`/api/payment/${referenceNumber}`);
                    data = await response.json();

                    if (!response.ok) {
                        if (response.status === 410) {
                            showExpired();
                            return;
                        }
                        // Fall back to demo mode if API fails
                        data = { data: demoPaymentData, demo: true };
                    }
                }

                // Show content after loading
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('paymentContent').style.display = 'block';

                    // Populate payment details
                    document.getElementById('beneficiary').textContent = data.data.beneficiary;
                    document.getElementById('amount').textContent = parseFloat(data.data.amount).toFixed(3);
                    document.getElementById('currency').textContent = data.data.currency || 'KWD';
                    document.getElementById('paymentDate').textContent = data.data.paymentDate || new Date().toLocaleDateString('en-GB');
                    document.getElementById('referenceNumber').textContent = data.data.referenceNumber;
                    document.getElementById('transactionId').textContent = data.data.transactionId;
                    document.getElementById('description').textContent = data.data.description;

                    // Show demo banner if in demo mode
                    if (data.demo) {
                        const demoBanner = document.createElement('div');
                        demoBanner.className = 'status-message warning';
                        demoBanner.innerHTML = '<strong>⚠️ Demo Mode</strong> - This is a demonstration';
                        demoBanner.style.marginTop = '20px';
                        document.querySelector('.container').insertBefore(demoBanner, document.querySelector('#paymentContent'));
                    }
                }, 1500);

            } catch (error) {
                console.error('Error loading payment details:', error);
                // Show demo data on error
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('paymentContent').style.display = 'block';
                document.getElementById('beneficiary').textContent = demoPaymentData.beneficiary;
                document.getElementById('amount').textContent = demoPaymentData.amount;
                document.getElementById('currency').textContent = demoPaymentData.currency;
                document.getElementById('paymentDate').textContent = demoPaymentData.paymentDate;
                document.getElementById('referenceNumber').textContent = demoPaymentData.referenceNumber;
                document.getElementById('transactionId').textContent = demoPaymentData.transactionId;
                document.getElementById('description').textContent = demoPaymentData.description;
            }
        }

        async function handlePayment(status) {
            const acceptBtn = document.getElementById('acceptBtn');
            const declineBtn = document.getElementById('declineBtn');
            const statusMessage = document.getElementById('statusMessage');

            // Disable buttons
            acceptBtn.disabled = true;
            declineBtn.disabled = true;

            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 1000));

            try {
                if (!isDemoMode && referenceNumber) {
                    const response = await fetch(`/api/payment/${referenceNumber}/status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update payment status');
                    }
                }

                // Show status message
                statusMessage.style.display = 'block';
                statusMessage.className = 'status-message ' + (status === 'completed' ? 'success' : 'error');

                if (status === 'completed') {
                    document.getElementById('statusText').textContent = '✓ Payment successful' + (isDemoMode ? ' (Demo)' : '');
                    document.getElementById('statusTextAr').textContent = '✓ تم الدفع بنجاح';
                } else {
                    document.getElementById('statusText').textContent = '✗ Payment declined' + (isDemoMode ? ' (Demo)' : '');
                    document.getElementById('statusTextAr').textContent = '✗ تم رفض الدفع';
                }

                // Hide action buttons after showing status
                document.getElementById('actionButtons').style.display = 'none';
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('Error: ' + error.message);

                // Re-enable buttons on error
                acceptBtn.disabled = false;
                declineBtn.disabled = false;
            }
        }

        function showExpired() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('expiredScreen').style.display = 'block';
        }

        function goHome() {
            window.location.href = '/';
        }

        // Load payment details on page load
        loadPaymentDetails();
    </script>
</body>
</html>
